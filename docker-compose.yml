services:
  # ===================================================================
  # MAIN APPLICATION
  # ===================================================================
  siscom-consumer:
    build: .
    container_name: siscom-consumer-dev
    volumes:
      - ./logs:/var/log/siscom-consumer
    environment:
      # Logging
      - RUST_LOG=${RUST_LOG}
      - RUST_BACKTRACE=1

      # Broker Configuration (choose one mode)
      - BROKER_TYPE=${BROKER_TYPE}
      - BROKER_HOST=${BROKER_HOST}
      - BROKER_TOPIC=${BROKER_TOPIC}
      - BROKER_GROUP_ID=${BROKER_GROUP_ID}

      # Kafka Configuration
      - KAFKA_BATCH_SIZE=100
      - KAFKA_BATCH_TIMEOUT_MS=100
      - KAFKA_COMPRESSION=snappy
      - KAFKA_RETRIES=3

      # Database Configuration
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_MAX_CONNECTIONS=${DB_MAX_CONNECTIONS}
      - DB_MIN_CONNECTIONS=${DB_MIN_CONNECTIONS}
      - DB_CONNECTION_TIMEOUT_SECS=${DB_CONNECTION_TIMEOUT_SECS}
      - DB_IDLE_TIMEOUT_SECS=${DB_IDLE_TIMEOUT_SECS}

      # Processing Configuration
      - PROCESSING_WORKER_THREADS=${PROCESSING_WORKER_THREADS}
      - PROCESSING_MESSAGE_BUFFER_SIZE=${PROCESSING_MESSAGE_BUFFER_SIZE}
      - PROCESSING_BATCH_PROCESSING_SIZE=${PROCESSING_BATCH_PROCESSING_SIZE}
      - PROCESSING_MAX_PARALLEL_DEVICES=${PROCESSING_MAX_PARALLEL_DEVICES}

      # Logging Configuration
      - LOGGING_FILE_PATH=${LOGGING_FILE_PATH}
      - LOGGING_MAX_FILE_SIZE_MB=${LOGGING_MAX_FILE_SIZE_MB}
      - LOGGING_MAX_FILES=${LOGGING_MAX_FILES}
      - LOGGING_JSON_FORMAT=${LOGGING_JSON_FORMAT}
      - KAFKA_SASL_MECHANISM=${KAFKA_SASL_MECHANISM}
      - KAFKA_USERNAME=${KAFKA_USERNAME}
      - KAFKA_PASSWORD=${KAFKA_PASSWORD}
      - KAFKA_SECURITY_PROTOCOL=${KAFKA_SECURITY_PROTOCOL}
      - CMAKE_ARGS=-DWITH_SASL=ON -DWITH_SSL=ON
    profiles:
      - kafka
    networks:
      - siscom-network


networks:
  siscom-network:
    external: true